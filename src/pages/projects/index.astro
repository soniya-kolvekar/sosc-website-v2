---
import Layout from "@/layouts/Layout.astro";
import ProjectCard from "@/components/cards/ProjectCard.astro";
import { getCollection } from "astro:content";
import slugify from "slugify";
import { ChevronDown, RotateCcw, Search } from "@lucide/astro";

const projects = await getCollection("projects");

const parsedProjects = projects
  .map(({ data }) => ({
    title: data.title,
    description: data.description,
    cover: data.cover,
    techStack: data.techStack,
    maintainers: data.maintainers,
    status: data.status,
    category: data.category,
    tags: data.tags,
    github: data.github,
    community: data.community,
    date: data.date,
    link: slugify(data.title, { lower: true, strict: true }),
  }))
  .sort((a, b) => {
    // Community projects first, then by date
    if (a.community && !b.community) return -1;
    if (!a.community && b.community) return 1;
    return new Date(b.date).getTime() - new Date(a.date).getTime();
  });

// Extract unique values for filters
const allCategories = [...new Set(parsedProjects.map((p) => p.category))];
const allTechStack = [...new Set(parsedProjects.flatMap((p) => p.techStack))];
const allStatuses = [...new Set(parsedProjects.map((p) => p.status))];

const communityProjects = parsedProjects.filter((p) => p.community);
const regularProjects = parsedProjects.filter((p) => !p.community);
---

<Layout>
  <section
    class="bg-background text-foreground mx-auto max-w-7xl space-y-8 px-4 py-16 md:px-8"
  >
    <div class="bg-background w-full py-3">
      <div class="flex flex-wrap items-center gap-6">
        <div class="flex min-w-[200px] flex-1 items-center gap-3">
          <Search class="text-muted-foreground h-4 w-4" />
          <input
            type="text"
            placeholder="SEARCH PROJECTS..."
            class="placeholder:text-muted-foreground/40 w-full border-none bg-transparent text-xs tracking-widest uppercase outline-none focus:ring-0"
          />
        </div>

        <div class="bg-border hidden h-6 w-px md:block"></div>

        <div class="flex flex-wrap items-center gap-8">
          <button
            id="clear-filters"
            class="text-destructive hidden items-center gap-1.5 text-[11px] font-bold tracking-widest transition-opacity hover:opacity-70"
          >
            <RotateCcw class="h-3.5 w-3.5" />
          </button>

          <div class="group custom-dropdown relative">
            <button class="flex items-center gap-3 py-1 focus:outline-none">
              <span
                class="text-muted-foreground text-[11px] font-bold tracking-wider uppercase"
                >Category</span
              >
              <span
                class="selected-label min-w-10 text-left text-sm font-medium uppercase"
                >All</span
              >
              <ChevronDown
                class="text-muted-foreground h-3 w-3 transition-transform group-focus-within:rotate-180"
              />
            </button>

            <div
              class="border-border bg-background absolute top-[calc(100%+8px)] left-0 z-50 hidden min-w-[180px] flex-col border py-0 group-focus-within:block"
            >
              <button
                class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                data-value="">All</button
              >
              {
                allCategories.map((category) => (
                  <button
                    class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                    data-value={category}
                  >
                    {category}
                  </button>
                ))
              }
            </div>
          </div>

          <div class="group custom-dropdown relative">
            <button class="flex items-center gap-3 py-1 focus:outline-none">
              <span
                class="text-muted-foreground text-[11px] font-bold tracking-wider uppercase"
                >Status</span
              >
              <span
                class="selected-label min-w-10 text-left text-sm font-medium uppercase"
                >All</span
              >
              <ChevronDown
                class="text-muted-foreground h-3 w-3 transition-transform group-focus-within:rotate-180"
              />
            </button>

            <div
              class="border-border bg-background absolute top-[calc(100%+8px)] left-0 z-50 hidden min-w-[180px] flex-col border py-0 group-focus-within:block"
            >
              <button
                class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                data-value="">All</button
              >
              {
                allStatuses.map((status) => (
                  <button
                    class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                    data-value={status}
                  >
                    {status}
                  </button>
                ))
              }
            </div>
          </div>

          <div class="group custom-dropdown relative">
            <button class="flex items-center gap-3 py-1 focus:outline-none">
              <span
                class="text-muted-foreground text-[11px] font-bold tracking-wider uppercase"
                >Tech</span
              >
              <span
                class="selected-label min-w-[40px] text-left text-sm font-medium uppercase"
                >All</span
              >
              <ChevronDown
                class="text-muted-foreground h-3 w-3 transition-transform group-focus-within:rotate-180"
              />
            </button>

            <div
              class="border-border bg-background absolute top-[calc(100%+8px)] left-0 z-50 hidden min-w-[180px] flex-col border py-0 group-focus-within:block"
            >
              <button
                class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                data-value="">All</button
              >
              {
                allTechStack.map((tech) => (
                  <button
                    class="hover:bg-foreground hover:text-background border-border w-full border-b px-4 py-2 text-left text-[11px] font-bold uppercase transition-colors last:border-0"
                    data-value={tech}
                  >
                    {tech}
                  </button>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Community Projects Section -->
    {
      communityProjects.length > 0 && (
        <div class="space-y-4">
          <h2 class="text-2xl font-bold">Community Projects</h2>
          <div class="projects-grid-separators grid grid-cols-1 gap-x-8 gap-y-6 md:grid-cols-2 lg:grid-cols-3">
            {communityProjects.map((project) => (
              <div
                class="project-card"
                data-category={project.category}
                data-status={project.status}
                data-tech={project.techStack.join(",")}
              >
                <ProjectCard {...project} />
              </div>
            ))}
          </div>
        </div>
      )
    }

    <!-- Member Projects Grid -->
    <div class="space-y-4">
      <h2 class="text-2xl font-bold">Member Projects</h2>
      <div
        id="projects-grid"
        class="projects-grid-separators grid grid-cols-1 gap-x-8 gap-y-6 sm:grid-cols-2 lg:grid-cols-3"
      >
        {
          regularProjects.map((project) => (
            <div
              class="project-card"
              data-category={project.category}
              data-status={project.status}
              data-tech={project.techStack.join(",")}
            >
              <ProjectCard {...project} />
            </div>
          ))
        }
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden py-12 text-center">
      <svg
        class="text-muted-foreground mx-auto h-12 w-12"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <h3 class="mt-4 text-lg font-semibold">No projects found</h3>
      <p class="text-muted-foreground mt-2">
        Try adjusting your filters to find what you're looking for.
      </p>
    </div>
  </section>
</Layout>

<script>
  const searchInput = document.querySelector(
    'input[type="text"]',
  ) as HTMLInputElement;
  const dropdowns = document.querySelectorAll(".custom-dropdown");
  const clearFiltersBtn = document.getElementById(
    "clear-filters",
  ) as HTMLButtonElement;
  const emptyState = document.getElementById("empty-state") as HTMLDivElement;
  const projectCards = document.querySelectorAll(
    ".project-card",
  ) as NodeListOf<HTMLDivElement>;

  const filters = {
    search: "",
    category: "",
    status: "",
    tech: "",
  };

  function filterProjects() {
    let visibleCount = 0;

    projectCards.forEach((card) => {
      const cardTitle =
        card.querySelector("h3")?.textContent?.toLowerCase() || "";
      const cardCategory = card.dataset.category || "";
      const cardStatus = card.dataset.status || "";
      const cardTech = card.dataset.tech || "";

      const matchesSearch =
        !filters.search || cardTitle.includes(filters.search.toLowerCase());
      const matchesCategory =
        !filters.category || cardCategory === filters.category;
      const matchesStatus = !filters.status || cardStatus === filters.status;
      const matchesTech =
        !filters.tech || cardTech.split(",").includes(filters.tech);

      if (matchesSearch && matchesCategory && matchesStatus && matchesTech) {
        card.classList.remove("hidden");
        visibleCount++;
      } else {
        card.classList.add("hidden");
      }
    });

    emptyState.classList.toggle("hidden", visibleCount > 0);
    const hasActiveFilters =
      filters.search || filters.category || filters.status || filters.tech;
    clearFiltersBtn.classList.toggle("hidden", !hasActiveFilters);
  }

  dropdowns.forEach((dropdown) => {
    const label = dropdown.querySelector(".selected-label") as HTMLSpanElement;
    const buttons = dropdown.querySelectorAll("button[data-value]");
    const filterType = dropdown
      .querySelector("span:first-child")
      ?.textContent?.toLowerCase()
      .trim();

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const value = (btn as HTMLButtonElement).dataset.value || "";
        const text = btn.textContent?.trim() || "All";

        label.textContent = text;

        if (filterType === "category") filters.category = value;
        if (filterType === "status") filters.status = value;
        if (filterType === "tech") filters.tech = value;

        (document.activeElement as HTMLElement)?.blur();

        filterProjects();
      });
    });
  });

  searchInput?.addEventListener("input", (e) => {
    filters.search = (e.target as HTMLInputElement).value;
    filterProjects();
  });

  clearFiltersBtn.addEventListener("click", () => {
    filters.search = "";
    filters.category = "";
    filters.status = "";
    filters.tech = "";

    if (searchInput) searchInput.value = "";
    dropdowns.forEach((d) => {
      const label = d.querySelector(".selected-label");
      if (label) label.textContent = "All";
    });

    filterProjects();
  });
</script>

<style>
  /* Mobile: horizontal separator between cards */
  .projects-grid-separators > :global(.project-card) {
    border-bottom: 1px solid rgba(128, 128, 128, 0.15);
    padding-bottom: 1.5rem;
  }
  .projects-grid-separators > :global(.project-card:last-child) {
    border-bottom: none;
    padding-bottom: 0;
  }

  /* Tablet (2 columns): vertical separator */
  @media (min-width: 640px) {
    .projects-grid-separators > :global(.project-card) {
      border-bottom: none;
      padding-bottom: 0;
      border-right: 1px solid rgba(128, 128, 128, 0.15);
      padding-right: 1.5rem;
    }
    /* Remove right border on every 2nd item (last in row) and last item */
    .projects-grid-separators > :global(.project-card:nth-child(2n)),
    .projects-grid-separators > :global(.project-card:last-child) {
      border-right: none;
      padding-right: 0;
    }
  }

  /* Desktop (3 columns): vertical separator */
  @media (min-width: 1024px) {
    .projects-grid-separators > :global(.project-card) {
      border-right: 1px solid rgba(128, 128, 128, 0.15);
      padding-right: 1.5rem;
    }
    .projects-grid-separators > :global(.project-card:nth-child(2n)) {
      border-right: 1px solid rgba(128, 128, 128, 0.15);
      padding-right: 1.5rem;
    }
    /* Remove right border on every 3rd item (last in row) and last item */
    .projects-grid-separators > :global(.project-card:nth-child(3n)),
    .projects-grid-separators > :global(.project-card:last-child) {
      border-right: none;
      padding-right: 0;
    }
  }
</style>
