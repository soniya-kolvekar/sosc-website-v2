---
import Layout from "@/layouts/Layout.astro";
import MarkdownLayout from "@/layouts/MarkdownLayout.astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import slugify from "slugify";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => ({
    params: {
      slug: slugify(project.data.title, { lower: true, strict: true }),
    },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
const {
  title,
  date,
  cover,
  description,
  techStack,
  maintainers,
  status,
  category,
  tags = [],
  github,
  demo,
  documentation,
} = project.data;

const formattedDate = new Date(date).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const statusLabels: Record<string, string> = {
  active: "Active",
  maintained: "Maintained",
  archived: "Archived",
  completed: "Completed",
  "in-progress": "In Progress",
};
---

<Layout>
  <main class="mx-auto max-w-4xl px-4 py-20 md:px-8">
    <!-- Project Header -->
    <div class="mb-10 border-b border-gray-100 pb-10">
      <!-- Maintainers & Meta Row -->
      <div class="mb-6 flex flex-wrap items-center gap-4">
        <div class="flex items-center">
          {
            maintainers.slice(0, 3).map((maintainer, i) => (
              <a
                href={`https://github.com/${maintainer}`}
                target="_blank"
                rel="noopener noreferrer"
                class="group relative"
                style={i > 0 ? "margin-left: -0.75rem;" : ""}
              >
                <img
                  src={`https://github.com/${maintainer}.png`}
                  alt={maintainer}
                  class="h-12 w-12 rounded-full border-2 border-white bg-gray-50 transition-transform group-hover:z-10 group-hover:scale-105"
                  loading="eager"
                  decoding="async"
                  onerror="this.onerror=null; this.src='/github_avatar.svg';"
                />
              </a>
            ))
          }
          {
            maintainers.length > 3 && (
              <span
                class="flex h-12 w-12 items-center justify-center rounded-full border-2 border-white bg-gray-100 text-xs font-medium text-gray-500"
                style="margin-left: -0.75rem;"
              >
                +{maintainers.length - 3}
              </span>
            )
          }
        </div>
        <div class="flex flex-col">
          <div class="flex items-center gap-2">
            {
              maintainers.slice(0, 2).map((maintainer, i) => (
                <>
                  <a
                    href={`https://github.com/${maintainer}`}
                    target="_blank"
                    class="hover:text-primary text-sm font-bold text-gray-900 transition-colors"
                  >
                    @{maintainer}
                  </a>
                  {i < Math.min(maintainers.length, 2) - 1 && (
                    <span class="text-gray-300">|</span>
                  )}
                </>
              ))
            }
            {
              maintainers.length > 2 && (
                <span class="text-xs text-gray-400">
                  +{maintainers.length - 2} more
                </span>
              )
            }
          </div>
          <span class="text-xs text-gray-400 italic">Maintainers</span>
        </div>
        <div
          class="ml-auto flex flex-wrap items-center gap-3 text-xs text-gray-400"
        >
          <span class="font-medium">{formattedDate}</span>
          <span class="text-gray-200">|</span>
          <span class="decoration-primary/30 underline underline-offset-2"
            >{category}</span
          >
          <span
            class:list={[
              "rounded-full px-2 py-0.5 text-[10px] font-bold tracking-wider uppercase",
              status === "active" && "bg-green-50 text-green-600",
              status === "maintained" && "bg-blue-50 text-blue-600",
              status === "archived" && "bg-gray-100 text-gray-500",
              status === "completed" && "bg-yellow-50 text-yellow-600",
              status === "in-progress" && "bg-orange-50 text-orange-600",
            ]}
          >
            {statusLabels[status]}
          </span>
        </div>
      </div>

      <!-- Title -->
      <h1 class="text-4xl leading-tight font-black text-gray-900 md:text-6xl">
        {title}
      </h1>

      <!-- Description -->
      <p class="mt-4 text-lg text-gray-500">{description}</p>

      <!-- Tech Stack & Tags -->
      <div class="mt-6 flex flex-wrap gap-2">
        {
          techStack.map((tech) => (
            <span class="hover:border-primary hover:text-primary border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-600 transition-colors">
              {tech}
            </span>
          ))
        }
        {
          tags.map((tag) => (
            <span class="bg-primary/10 text-primary px-3 py-1 text-xs font-medium">
              {tag}
            </span>
          ))
        }
      </div>

      <!-- Action Links -->
      <div class="mt-6 flex flex-wrap items-center gap-4">
        {
          github && (
            <a
              href={github}
              target="_blank"
              rel="noopener noreferrer"
              class="group inline-flex items-center gap-2 border border-gray-900 bg-gray-900 px-4 py-2 text-xs font-bold tracking-wider text-white uppercase transition-all hover:bg-transparent hover:text-gray-900"
            >
              <Icon name="mdi:github" class="h-4 w-4" />
              View on GitHub
            </a>
          )
        }
        {
          demo && (
            <a
              href={demo}
              target="_blank"
              rel="noopener noreferrer"
              class="group border-primary bg-primary hover:text-primary inline-flex items-center gap-2 border px-4 py-2 text-xs font-bold tracking-wider text-white uppercase transition-all hover:bg-transparent"
            >
              <Icon name="mdi:open-in-new" class="h-4 w-4" />
              Live Demo
            </a>
          )
        }
        {
          documentation && (
            <a
              href={documentation}
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-primary inline-flex items-center gap-2 text-xs font-bold tracking-wider text-gray-400 uppercase transition-colors"
            >
              <Icon name="mdi:file-document" class="h-4 w-4" />
              Documentation
            </a>
          )
        }
      </div>
    </div>

    <!-- Project Cover -->
    {
      cover && (
        <div class="mb-12 overflow-hidden bg-gray-50">
          <Image
            src={cover}
            alt={title}
            class="h-auto w-full object-cover"
            loading="eager"
            format="webp"
            quality={80}
          />
        </div>
      )
    }

    <!-- Project Markdown Content -->
    <MarkdownLayout>
      <div class="prose-project">
        <Content />
      </div>
    </MarkdownLayout>

    <!-- Back to Projects Link -->
    <div class="mt-16 border-t border-gray-100 pt-8">
      <a
        href="/projects"
        class="group hover:text-primary inline-flex items-center gap-2 text-xs font-bold tracking-wider text-gray-400 uppercase transition-colors"
      >
        <Icon
          name="mdi:chevron-left"
          class="h-4 w-4 transition-transform group-hover:-translate-x-1"
        />
        Back to all projects
      </a>
    </div>
  </main>
</Layout>

<style>
  /* Project Prose Styling */
  .prose-project {
    color: #4b5563;
    font-size: 1.125rem;
    line-height: 1.8;
  }

  .prose-project :global(h1:first-child) {
    display: none;
  }

  .prose-project :global(h2) {
    font-size: 1.875rem;
    font-weight: 900;
    text-transform: uppercase;
    color: #111827;
    margin-top: 4rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #3ce56e;
    padding-left: 1.5rem;
    line-height: 1;
  }

  .prose-project :global(h3) {
    font-size: 1.5rem;
    font-weight: 800;
    color: #111827;
    margin-top: 3rem;
    margin-bottom: 1rem;
  }

  .prose-project :global(h4) {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose-project :global(p) {
    margin-bottom: 1.5rem;
  }

  .prose-project :global(ul),
  .prose-project :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .prose-project :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose-project :global(img) {
    margin: 3rem 0;
    border: 1px solid #f3f4f6;
  }

  .prose-project :global(pre) {
    background: #111827 !important;
    padding: 2rem !important;
    margin: 2.5rem 0 !important;
    border-radius: 0 !important;
    font-size: 0.875rem !important;
  }

  .prose-project :global(code:not(pre code)) {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    color: #111827;
  }

  .prose-project :global(a) {
    color: #3ce56e;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s;
  }

  .prose-project :global(a:hover) {
    color: #2cb557;
  }

  .prose-project :global(hr) {
    margin: 3rem 0;
    border: none;
    border-top: 1px solid #e5e7eb;
  }

  .prose-project :global(blockquote) {
    border-left: 4px solid #e5e7eb;
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #6b7280;
  }

  .prose-project :global(table) {
    width: 100%;
    margin: 2rem 0;
    border-collapse: collapse;
  }

  .prose-project :global(th),
  .prose-project :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
    text-align: left;
  }

  .prose-project :global(th) {
    background: #f9fafb;
    font-weight: 700;
  }
</style>
